<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Monitor</title>
    <style>
        body {
            font-family: "Helvetica", sans-serif;
            font-size: 18px;
            color: #ffffff;
            background-color: #000000;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .display {
            background: #111;
            border: 8px solid #444;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 
                inset 0 0 20px #000,
                0 0 20px #000;
            max-width: 800px;
            width: 100%;
        }
        
        .title {
            text-align: center;
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }
        
        .metrics-container {
            display: flex;
            justify-content: space-around;
            gap: 40px;
            flex-wrap: wrap;
        }
        
        .metric-section {
            text-align: center;
            min-width: 300px;
        }
        
        .metric-label {
            color: #666;
            font-size: 1rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .seven-segment-display {
            background: #000;
            border: 2px inset #333;
            border-radius: 10px;
            padding: 20px;
            display: inline-block;
            margin-bottom: 10px;
            position: relative;
        }
        
        .digit-container {
            display: inline-block;
            margin: 0 5px;
        }
        
        /* 7-segment display from CodePen */
        .digit {
            /* options */
            --aspectRatio: .57;
            --height: 100px;
            /* this is half the thickness of a segment expressed as a fraction of the height */
            /* change the thickness of the segments by changing the decimal number */
            --segment-thickness: .14;
            --half-segment-minor-dimention: calc(var(--height) * var(--segment-thickness) / 2);
            --segment-spacing: 5%;
            --on-color: rgba(0, 220, 0);
            --off-color: rgba(0, 220, 0, .2);
            
            height: var(--height);
            width: calc(var(--height) * var(--aspectRatio));
            
            margin: 2px;
            
            display: inline-grid;
            grid-template-columns: var(--half-segment-minor-dimention)
                var(--half-segment-minor-dimention)
                1fr
                var(--half-segment-minor-dimention)
                var(--half-segment-minor-dimention);
            grid-template-rows: var(--half-segment-minor-dimention)
                var(--half-segment-minor-dimention)
                1fr
                var(--half-segment-minor-dimention)
                var(--half-segment-minor-dimention)
                1fr
                var(--half-segment-minor-dimention)
                var(--half-segment-minor-dimention);
            
            transform: skew(-3deg);
        }

        .digit .segment {
            width: 100%;
            height: 100%;
            line-height: 0;
            display: flex;
            align-items: center;
        }

        .digit .segment.segA,
        .digit .segment.segG,
        .digit .segment.segD {
            flex-direction: column;
        }

        .digit .segment.segA {
            grid-area: 1 / 2 / 3 / 5;
        }

        .digit .segment.segB {
            grid-area: 2 / 4 / 5 / 6;
        }

        .digit .segment.segC {
            grid-area: 5 / 4 / 8 / 6;
        }

        .digit .segment.segD {
            grid-area: 7 / 2 / 9 / 5;
        }

        .digit .segment.segE {
            grid-area: 5 / 1 / 8 / 3;
        }

        .digit .segment.segF {
            grid-area: 2 / 1 / 5 / 3;
        }

        .digit .segment.segG {
            grid-area: 4 / 2 / 6 / 5;
        }

        .digit .segment::before,
        .digit .segment::after {
            display: block;
            content: "";
            box-sizing: border-box;
        }

        /* horizontal segments */
        .digit .segment.segA::before,
        .digit .segment.segA::after,
        .digit .segment.segG::before,
        .digit .segment.segG::after,
        .digit .segment.segD::before,
        .digit .segment.segD::after {
            border-right: var(--half-segment-minor-dimention) solid transparent;
            border-left: var(--half-segment-minor-dimention) solid transparent;
            width: calc(100% - var(--segment-spacing)); /* not 100% so there's spacing between the segments */
            height: 0;
        }

        .digit .segment.segA::before,
        .digit .segment.segG::before,
        .digit .segment.segD::before {
            border-bottom: var(--half-segment-minor-dimention) solid var(--off-color);
        }

        .digit .segment.segA::after,
        .digit .segment.segG::after,
        .digit .segment.segD::after {
            border-top: var(--half-segment-minor-dimention) solid var(--off-color);
        }

        .digit .segment.on.segA::before,
        .digit .segment.on.segG::before,
        .digit .segment.on.segD::before {
            border-bottom: var(--half-segment-minor-dimention) solid var(--on-color);
        }

        .digit .segment.on.segA::after,
        .digit .segment.on.segG::after,
        .digit .segment.on.segD::after {
            border-top: var(--half-segment-minor-dimention) solid var(--on-color);
        }

        /* vertical segments */
        .digit .segment.segB::before,
        .digit .segment.segB::after,
        .digit .segment.segC::before,
        .digit .segment.segC::after,
        .digit .segment.segE::before,
        .digit .segment.segE::after,
        .digit .segment.segF::before,
        .digit .segment.segF::after {
            border-top: var(--half-segment-minor-dimention) solid transparent;
            border-bottom: var(--half-segment-minor-dimention) solid transparent;
            width: 0;
            height: calc(100% - var(--segment-spacing));
        }

        .digit .segment.segB::before,
        .digit .segment.segC::before,
        .digit .segment.segE::before,
        .digit .segment.segF::before {
            border-right: var(--half-segment-minor-dimention) solid var(--off-color);
        }

        .digit .segment.segB::after,
        .digit .segment.segC::after,
        .digit .segment.segE::after,
        .digit .segment.segF::after {
            border-left: var(--half-segment-minor-dimention) solid var(--off-color);
        }

        .digit .segment.on.segB::before,
        .digit .segment.on.segC::before,
        .digit .segment.on.segE::before,
        .digit .segment.on.segF::before {
            border-right: var(--half-segment-minor-dimention) solid var(--on-color);
        }

        .digit .segment.on.segB::after,
        .digit .segment.on.segC::after,
        .digit .segment.on.segE::after,
        .digit .segment.on.segF::after {
            border-left: var(--half-segment-minor-dimention) solid var(--on-color);
        }

        /******* digit classes *******/

        .digit.digZero .segment.segA::before,
        .digit.digZero .segment.segA::after,
        .digit.digZero .segment.segD::before,
        .digit.digZero .segment.segD::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digZero .segment.segB::before,
        .digit.digZero .segment.segB::after,
        .digit.digZero .segment.segC::before,
        .digit.digZero .segment.segC::after,
        .digit.digZero .segment.segE::before,
        .digit.digZero .segment.segE::after,
        .digit.digZero .segment.segF::before,
        .digit.digZero .segment.segF::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digOne .segment.segB::before,
        .digit.digOne .segment.segB::after,
        .digit.digOne .segment.segC::before,
        .digit.digOne .segment.segC::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digTwo .segment.segA::before,
        .digit.digTwo .segment.segA::after,
        .digit.digTwo .segment.segD::before,
        .digit.digTwo .segment.segD::after,
        .digit.digTwo .segment.segG::before,
        .digit.digTwo .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digTwo .segment.segB::before,
        .digit.digTwo .segment.segB::after,
        .digit.digTwo .segment.segE::before,
        .digit.digTwo .segment.segE::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digThree .segment.segA::before,
        .digit.digThree .segment.segA::after,
        .digit.digThree .segment.segD::before,
        .digit.digThree .segment.segD::after,
        .digit.digThree .segment.segG::before,
        .digit.digThree .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digThree .segment.segB::before,
        .digit.digThree .segment.segB::after,
        .digit.digThree .segment.segC::before,
        .digit.digThree .segment.segC::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digFour .segment.segG::before,
        .digit.digFour .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digFour .segment.segB::before,
        .digit.digFour .segment.segB::after,
        .digit.digFour .segment.segC::before,
        .digit.digFour .segment.segC::after,
        .digit.digFour .segment.segF::before,
        .digit.digFour .segment.segF::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digFive .segment.segA::before,
        .digit.digFive .segment.segA::after,
        .digit.digFive .segment.segD::before,
        .digit.digFive .segment.segD::after,
        .digit.digFive .segment.segG::before,
        .digit.digFive .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digFive .segment.segC::before,
        .digit.digFive .segment.segC::after,
        .digit.digFive .segment.segF::before,
        .digit.digFive .segment.segF::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digSix .segment.segA::before,
        .digit.digSix .segment.segA::after,
        .digit.digSix .segment.segD::before,
        .digit.digSix .segment.segD::after,
        .digit.digSix .segment.segG::before,
        .digit.digSix .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digSix .segment.segC::before,
        .digit.digSix .segment.segC::after,
        .digit.digSix .segment.segE::before,
        .digit.digSix .segment.segE::after,
        .digit.digSix .segment.segF::before,
        .digit.digSix .segment.segF::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digSeven .segment.segA::before,
        .digit.digSeven .segment.segA::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digSeven .segment.segB::before,
        .digit.digSeven .segment.segB::after,
        .digit.digSeven .segment.segC::before,
        .digit.digSeven .segment.segC::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digEight .segment.segA::before,
        .digit.digEight .segment.segA::after,
        .digit.digEight .segment.segD::before,
        .digit.digEight .segment.segD::after,
        .digit.digEight .segment.segG::before,
        .digit.digEight .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digEight .segment.segB::before,
        .digit.digEight .segment.segB::after,
        .digit.digEight .segment.segC::before,
        .digit.digEight .segment.segC::after,
        .digit.digEight .segment.segE::before,
        .digit.digEight .segment.segE::after,
        .digit.digEight .segment.segF::before,
        .digit.digEight .segment.segF::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }

        .digit.digNine .segment.segA::before,
        .digit.digNine .segment.segA::after,
        .digit.digNine .segment.segD::before,
        .digit.digNine .segment.segD::after,
        .digit.digNine .segment.segG::before,
        .digit.digNine .segment.segG::after {
            border-top-color: var(--on-color);
            border-bottom-color: var(--on-color);
        }
        .digit.digNine .segment.segB::before,
        .digit.digNine .segment.segB::after,
        .digit.digNine .segment.segC::before,
        .digit.digNine .segment.segC::after,
        .digit.digNine .segment.segF::before,
        .digit.digNine .segment.segF::after {
            border-left-color: var(--on-color);
            border-right-color: var(--on-color);
        }
        
        .unit {
            color: #666;
            font-size: 1.2rem;
            margin-top: 10px;
        }
        
        .status {
            text-align: center;
            margin-top: 30px;
            padding: 15px 30px;
            border: 2px solid #666;
            border-radius: 10px;
            background: #111;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status.good { 
            border-color: #0dc; 
            color: #0dc; 
            background: #001100;
        }
        
        .status.warning { 
            border-color: #ff0; 
            color: #ff0;
            background: #111100;
        }
        
        .status.danger { 
            border-color: #f00; 
            color: #f00;
            background: #110000;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.5rem;
            animation: blink 1s linear infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .error {
            color: #f00;
            text-align: center;
            font-size: 1.2rem;
            padding: 20px;
        }
        
        .timestamp {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #444;
            font-size: 0.8rem;
            font-family: monospace;
        }
        
        .decimal-point {
            width: 8px;
            height: 8px;
            background: var(--on-color);
            border-radius: 50%;
            position: absolute;
            bottom: 10px;
            right: -15px;
            box-shadow: 0 0 5px var(--on-color);
        }
        
        .decimal-point.off {
            background: var(--off-color);
            box-shadow: none;
        }
        
        @media (max-width: 768px) {
            .display {
                padding: 20px;
            }
            
            .metrics-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .digit {
                --height: 75px;
            }
        }
    </style>
</head>
<body>
    <div class="display">
        <div class="title">CO2 ENVIRONMENTAL MONITOR</div>
        <div id="content">
            <div class="loading">INITIALIZING SYSTEM...</div>
        </div>
    </div>
    
    <div class="timestamp" id="timestamp"></div>
    
    <script>
        function createDigit(value, showDecimal = false) {
            const digitClass = {
                '0': 'digZero',
                '1': 'digOne', 
                '2': 'digTwo',
                '3': 'digThree',
                '4': 'digFour',
                '5': 'digFive',
                '6': 'digSix',
                '7': 'digSeven',
                '8': 'digEight',
                '9': 'digNine',
                ' ': ''
            };
            
            const className = digitClass[value] || '';
            
            let html = `<div class="digit ${className}">`;
            html += '<div class="segment segA"></div>';
            html += '<div class="segment segB"></div>';
            html += '<div class="segment segC"></div>';
            html += '<div class="segment segD"></div>';
            html += '<div class="segment segE"></div>';
            html += '<div class="segment segF"></div>';
            html += '<div class="segment segG"></div>';
            if (showDecimal) {
                html += '<div class="decimal-point"></div>';
            }
            html += '</div>';
            
            return html;
        }
        
        function createDisplay(value, decimals = 0) {
            const str = value.toString();
            const parts = str.split('.');
            let html = '<div class="digit-container">';
            
            // Integer part
            const intPart = parts[0].padStart(4, ' ');
            for (let i = 0; i < intPart.length; i++) {
                const showDecimal = (decimals > 0 && i === intPart.length - 1);
                html += createDigit(intPart[i], showDecimal);
            }
            
            // Decimal part
            if (decimals > 0 && parts[1]) {
                const decPart = parts[1].padEnd(decimals, '0').substring(0, decimals);
                for (let i = 0; i < decPart.length; i++) {
                    html += createDigit(decPart[i]);
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleString();
        }
        
        function getCO2Status(co2) {
            if (co2 < 400) return { status: 'EXCELLENT', class: 'good' };
            if (co2 < 800) return { status: 'GOOD', class: 'good' };
            if (co2 < 1000) return { status: 'MODERATE', class: 'warning' };
            if (co2 < 1500) return { status: 'POOR', class: 'warning' };
            return { status: 'DANGEROUS', class: 'danger' };
        }
        
        function parseMetrics(text) {
            const lines = text.split('\n');
            const metrics = {};
            
            for (const line of lines) {
                if (line.startsWith('co2mon_temp_celsius ')) {
                    metrics.temperature = parseFloat(line.split(' ')[1]);
                } else if (line.startsWith('co2mon_co2_ppm ')) {
                    metrics.co2 = parseInt(line.split(' ')[1]);
                } else if (line.startsWith('co2mon_device_errors_total ')) {
                    metrics.errors = parseInt(line.split(' ')[1]);
                }
            }
            
            return metrics;
        }
        
        function displayMetrics(metrics) {
            const co2Status = getCO2Status(metrics.co2);
            
            const content = `
                <div class="metrics-container">
                    <div class="metric-section">
                        <div class="metric-label">CO2 Concentration</div>
                        <div class="seven-segment-display">
                            ${createDisplay(metrics.co2)}
                        </div>
                        <div class="unit">PPM</div>
                    </div>
                    <div class="metric-section">
                        <div class="metric-label">Temperature</div>
                        <div class="seven-segment-display">
                            ${createDisplay(metrics.temperature.toFixed(1), 1)}
                        </div>
                        <div class="unit">°C</div>
                    </div>
                </div>
                <div class="status ${co2Status.class}">
                    Air Quality: ${co2Status.status}
                </div>
            `;
            
            document.getElementById('content').innerHTML = content;
        }
        
        function displayError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error">
                    SYSTEM ERROR: ${message}
                </div>
            `;
        }
        
        async function fetchMetrics() {
            try {
                const response = await fetch('./metrics');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                const metrics = parseMetrics(text);
                
                if (metrics.co2 !== undefined && metrics.temperature !== undefined) {
                    displayMetrics(metrics);
                } else {
                    throw new Error('INVALID SENSOR DATA');
                }
                
            } catch (error) {
                displayError(error.message);
            }
            
            updateTimestamp();
        }
        
        function startMonitoring() {
            fetchMetrics();
            setInterval(fetchMetrics, 5000);
        }
        
        // Start monitoring
        window.addEventListener('load', startMonitoring);
        
        // Update timestamp every second
        setInterval(updateTimestamp, 1000);
        updateTimestamp();
    </script>
</body>
</html>